<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Player</title>
    <style>
        body { margin: 0; background: #000; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            color: white; background: rgba(0,0,0,0.7); padding: 10px 15px;
            border-radius: 5px; text-decoration: none; font-weight: bold; border: 1px solid #444;
            transition: background 0.3s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.2); }
        .info-overlay {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            color: white; background: rgba(0,0,0,0.7); padding: 10px 15px;
            border-radius: 5px; font-size: 14px; max-width: 300px;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 18px; z-index: 50; display: none;
        }
        .error-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff6b6b; background: rgba(0,0,0,0.8); padding: 20px;
            border-radius: 8px; text-align: center; display: none; z-index: 60;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">‚Üê Back</a>
    <div id="loading">Loading stream...</div>
    <div id="error" class="error-message"></div>
    <div id="info" class="info-overlay"></div>
    <video id="vid" controls autoplay playsinline></video>

    <!-- Required Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/flv.js@latest/dist/flv.min.js"></script>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const streamUrl = urlParams.get('url');
        const video = document.getElementById('vid');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const infoDiv = document.getElementById('info');

        function showLoading() { loading.style.display = 'block'; errorDiv.style.display = 'none'; }
        function hideLoading() { loading.style.display = 'none'; }
        function showError(msg) { errorDiv.textContent = msg; errorDiv.style.display = 'block'; hideLoading(); }
        function showInfo(msg) { infoDiv.textContent = msg; }

        if (!streamUrl) {
            showError('No video source provided. Add ?url=STREAM_URL to the address bar');
            video.style.display = 'none';
            throw new Error('No URL provided');
        }

        // Determine stream type from URL
        const url = streamUrl.toLowerCase();
        const isHls = url.endsWith('.m3u8') || url.includes('.ts') || url.includes('mpegts') || url.includes('format=m3u8');
        const isFlv = url.endsWith('.flv') || url.includes('format=flv');
        const isM3u = url.endsWith('.m3u') || url.includes('type=m3u');
        
        showLoading();
        showInfo(`Stream type: ${isHls ? 'HLS/TS' : isFlv ? 'FLV' : isM3u ? 'M3U Playlist' : 'Native'}`);

        // Configure video element
        video.style.display = 'block';

        // Handle HLS/MPEG-TS streams
        if (isHls && Hls.isSupported()) {
            const hls = new Hls({
                debug: false,
                enableWorker: true,
                lowLatencyMode: true,
                progressive: true
            });
            
            hls.loadSource(streamUrl);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                hideLoading();
                video.play().catch(e => showError('Autoplay blocked. Click play to start.'));
            });
            
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    showError(`Stream error: ${data.type} - ${data.details}`);
                    console.error('HLS Error:', data);
                }
            });
            
            // For TS streams without proper HLS manifest
            video.addEventListener('loadeddata', hideLoading);
        }
        // Handle FLV streams
        else if (isFlv && flvjs.isSupported()) {
            const flvPlayer = flvjs.createPlayer({
                type: 'flv',
                url: streamUrl,
                isLive: true,
                withCredentials: false
            });
            
            flvPlayer.attachMediaElement(video);
            flvPlayer.load();
            
            flvPlayer.on(flvjs.Events.MEDIA_INFO, () => {
                hideLoading();
                video.play().catch(e => showError('Autoplay blocked. Click play to start.'));
            });
            
            flvPlayer.on(flvjs.Events.ERROR, (errorType, errorDetail) => {
                showError(`FLV error: ${errorType} - ${errorDetail}`);
                console.error('FLV Error:', errorType, errorDetail);
            });
        }
        // Handle M3U playlists (basic support)
        else if (isM3u) {
            fetch(streamUrl)
                .then(response => response.text())
                .then(data => {
                    const lines = data.split('\n');
                    const streamLines = lines.filter(line => line.trim() && !line.startsWith('#'));
                    
                    if (streamLines.length > 0) {
                        // Play first stream from playlist
                        const firstStream = streamLines[0].trim();
                        showInfo(`Playing first stream from playlist`);
                        console.log('M3U playlist loaded, redirecting to:', firstStream);
                        
                        // Re-run with the actual stream URL
                        window.location.href = `player.html?url=${encodeURIComponent(firstStream)}`;
                    } else {
                        showError('No valid streams found in M3U playlist');
                    }
                })
                .catch(err => showError(`Failed to load M3U playlist: ${err.message}`));
        }
        // Fallback to native playback
        else {
            video.src = streamUrl;
            
            video.addEventListener('loadeddata', hideLoading);
            video.addEventListener('canplay', hideLoading);
            video.addEventListener('error', (e) => {
                showError(`Video playback failed. Format may not be supported. Error: ${video.error?.message || 'Unknown'}`);
                console.error('Video Element Error:', video.error);
            });
            
            video.play().catch(e => {
                hideLoading();
                if (e.name === 'NotAllowedError') {
                    showError('Autoplay blocked by browser. Click play to start video.');
                } else if (e.name === 'NotSupportedError') {
                    showError('Video format not supported. Try using HLS (.m3u8) or FLV format.');
                }
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.hls) window.hls.destroy();
            if (window.flvPlayer) window.flvPlayer.destroy();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                video.paused ? video.play() : video.pause();
            } else if (e.key === 'f' || e.key === 'F') {
                video.requestFullscreen().catch(() => {});
            } else if (e.key === 'Escape') {
                document.exitFullscreen().catch(() => {});
            }
        });
    </script>
</body>
</html>